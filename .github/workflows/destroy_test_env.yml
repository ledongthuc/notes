name: Destroy PR qa environment

on:
  pull_request:
    types: [closed]

jobs:
  destroyPullRequestQAEnvironment:
    name: Destroy PR qa environment
    runs-on: ubuntu-latest
    steps:
      #      - uses: clowdhaus/argo-cd-action/@main
      #        with:
      #          version: 2.0.0
      #          command: version
      #          options: --client
      - name: Deploy Stage
        uses: fjogeleit/http-request-action@master
        with:
          # url: '${{ secrets.ARGOCD_HOST }}/applications/pr$BUILD_NUMBER'
          url: '${{ secrets.ARGOCD_HOST }}/applications/pr1643'
          method: 'DELETE'
          customHeaders: |
            {
              "Content-Type":"application/json", 
              "Authorization": "Bearer ${{ secrets.ARGOCD_TOKEN }}"
            }
      - name: Notify
        uses: actions/github-script@v4
        with:
          script: |
            await github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '/azp run destroy'
            })
